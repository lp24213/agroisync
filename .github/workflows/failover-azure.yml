name: Failover to Azure

on:
  workflow_dispatch:
    inputs:
      reason:
        description: 'Reason for failover'
        required: true
        default: 'Manual failover'
      environment:
        description: 'Target environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

env:
  AZURE_RESOURCE_GROUP: agrotm-rg
  AZURE_CONTAINER_APP: agrotm-solana

jobs:
  failover:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'production' }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
        
    - name: Check current health status
      run: |
        # Check if Azure services are healthy
        echo "Checking Azure service health..."
        
        # Check Container App status
        APP_STATUS=$(az containerapp show \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --name ${{ env.AZURE_CONTAINER_APP }} \
          --query "properties.runningStatus" \
          --output tsv)
          
        if [ "$APP_STATUS" != "Running" ]; then
          echo "Azure Container App is not healthy: $APP_STATUS"
          exit 1
        fi
        
        # Check Azure Database status
        DB_STATUS=$(az sql db show \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --server agrotm-sql-server \
          --name agrotm-db \
          --query "status" \
          --output tsv)
          
        if [ "$DB_STATUS" != "Online" ]; then
          echo "Azure SQL Database is not healthy: $DB_STATUS"
          exit 1
        fi
        
        echo "Azure services are healthy"
        
    - name: Scale up Azure services
      run: |
        # Scale up Container App
        az containerapp revision set-mode \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --name ${{ env.AZURE_CONTAINER_APP }} \
          --mode multiple \
          --revision-suffix failover-$(date +%s)
          
        # Scale up SQL Database if needed
        az sql db update \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --server agrotm-sql-server \
          --name agrotm-db \
          --capacity 10
          
    - name: Update DNS to point to Azure
      run: |
        # Update DNS records to point to Azure
        az network dns record-set a update \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --zone-name agrotm.com \
          --name www \
          --set aRecords[0].ipv4Address=${{ secrets.AZURE_APP_IP }}
          
        az network dns record-set a update \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --zone-name agrotm.com \
          --name api \
          --set aRecords[0].ipv4Address=${{ secrets.AZURE_API_IP }}
          
    - name: Update Azure Front Door
      run: |
        # Update Front Door routing rules
        az network front-door routing-rule update \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --front-door-name agrotm-frontdoor \
          --name defaultRoutingRule \
          --backend-pool agrotm-backend-pool
          
    - name: Wait for DNS propagation
      run: |
        echo "Waiting for DNS propagation..."
        sleep 60
        
        # Check if DNS is propagated
        for i in {1..10}; do
          echo "Checking DNS propagation... ($i/10)"
          
          if dig +short www.agrotm.com | grep -q "${{ secrets.AZURE_APP_IP }}"; then
            echo "DNS propagation successful"
            break
          fi
          
          sleep 30
        done
        
    - name: Run health checks
      run: |
        # Wait for application to be healthy
        sleep 30
        
        # Run health checks
        curl -f https://www.agrotm.com/health || exit 1
        curl -f https://api.agrotm.com/health || exit 1
        
        # Run smoke tests
        npm run test:smoke
        
    - name: Monitor failover
      run: |
        # Monitor failover for 10 minutes
        for i in {1..60}; do
          echo "Monitoring failover... ($i/60)"
          
          # Check application health
          HEALTH_STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://www.agrotm.com/health)
          
          if [ "$HEALTH_STATUS" = "200" ]; then
            echo "Application is healthy"
            break
          fi
          
          sleep 10
        done
        
        if [ "$HEALTH_STATUS" != "200" ]; then
          echo "Application failed health checks"
          exit 1
        fi
        
    - name: Update monitoring systems
      run: |
        # Update monitoring systems to use Azure endpoints
        curl -X POST ${{ secrets.MONITORING_WEBHOOK_URL }} \
          -H "Content-Type: application/json" \
          -d "{\"action\": \"failover\", \"provider\": \"azure\", \"environment\": \"${{ github.event.inputs.environment || 'production' }}\", \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"}"
          
    - name: Create failover record
      run: |
        # Create failover record in monitoring system
        az monitor log-analytics workspace query \
          --workspace ${{ secrets.AZURE_LOG_ANALYTICS_WORKSPACE }} \
          --analytics-query "ContainerAppConsoleLogs_CL | where ContainerAppName_s == '${{ env.AZURE_CONTAINER_APP }}' | where TimeGenerated > ago(1h) | summarize count() by bin(TimeGenerated, 1m)" \
          --output table
          
    - name: Notify failover success
      uses: 8398a7/action-slack@v3
      with:
        status: success
        channel: '#failover'
        webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
        text: |
          ✅ Failover to Azure successful!
          Environment: ${{ github.event.inputs.environment || 'production' }}
          Reason: ${{ github.event.inputs.reason }}
          URL: https://www.agrotm.com
      if: success()
      
    - name: Notify failover failure
      uses: 8398a7/action-slack@v3
      with:
        status: failure
        channel: '#failover'
        webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
        text: |
          ❌ Failover to Azure failed!
          Environment: ${{ github.event.inputs.environment || 'production' }}
          Reason: ${{ github.event.inputs.reason }}
          Check the logs for details.
      if: failure()
      
    - name: Rollback on failure
      run: |
        # Rollback DNS changes if failover fails
        az network dns record-set a update \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --zone-name agrotm.com \
          --name www \
          --set aRecords[0].ipv4Address=${{ secrets.PRIMARY_APP_IP }}
          
        az network dns record-set a update \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --zone-name agrotm.com \
          --name api \
          --set aRecords[0].ipv4Address=${{ secrets.PRIMARY_API_IP }}
          
        echo "Rolled back DNS changes"
      if: failure() 