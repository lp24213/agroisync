name: AGROTM.SOL Production Monitoring

on:
  schedule:
    # Run every 5 minutes
    - cron: '*/5 * * * *'
  workflow_dispatch:

env:
  VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
  VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID_PROD }}
  BACKEND_URL: ${{ secrets.BACKEND_URL }}
  NOTIFICATION_WEBHOOK_URL: ${{ secrets.NOTIFICATION_WEBHOOK_URL }}

jobs:
  validate-secrets:
    runs-on: ubuntu-latest
    steps:
      - name: Validate monitoring secrets
        run: |
          echo "ðŸ” Validating monitoring secrets..."
          
          if [ -z "${{ env.VERCEL_TOKEN }}" ]; then
            echo "âŒ VERCEL_TOKEN is not set"
            exit 1
          fi
          
          if [ -z "${{ env.VERCEL_ORG_ID }}" ]; then
            echo "âŒ VERCEL_ORG_ID is not set"
            exit 1
          fi
          
          if [ -z "${{ env.VERCEL_PROJECT_ID }}" ]; then
            echo "âŒ VERCEL_PROJECT_ID is not set"
            exit 1
          fi
          
          echo "âœ… All required secrets are configured"

  health-check:
    runs-on: ubuntu-latest
    needs: validate-secrets
    outputs:
      frontend-health-status: ${{ steps.frontend-health.outputs.status }}
      backend-health-status: ${{ steps.backend-health.outputs.status }}
      api-health-status: ${{ steps.api-health.outputs.status }}
      response-times-status: ${{ steps.response-times.outputs.status }}
    steps:
      - name: Check frontend health
        id: frontend-health
        run: |
          # Use the production URL directly since we know it
          PROD_URL="https://agrotmsol.com.br"
          echo "ðŸ¥ Checking frontend health: $PROD_URL"
          STATUS="failed"
          for i in {1..3}; do
            if curl -f -s --max-time 30 "$PROD_URL" > /dev/null; then
              echo "âœ… Frontend health check passed"
              STATUS="success"
              break
            else
              echo "âŒ Frontend health check failed (attempt $i/3)"
              sleep 10
            fi
          done
          echo "status=$STATUS" >> $GITHUB_OUTPUT
          echo "::set-output name=status::$STATUS"
      - name: Check backend health
        id: backend-health
        run: |
          BACKEND_URL="${{ env.BACKEND_URL }}"
          if [ -z "$BACKEND_URL" ]; then
            echo "âš ï¸ Backend URL not configured, skipping backend health check"
            STATUS="skipped"
            echo "status=$STATUS" >> $GITHUB_OUTPUT
            echo "::set-output name=status::$STATUS"
            exit 0
          fi
          echo "ðŸ¥ Checking backend health: $BACKEND_URL/health"
          STATUS="failed"
          for i in {1..3}; do
            if curl -f -s --max-time 30 "$BACKEND_URL/health" > /dev/null; then
              echo "âœ… Backend health check passed"
              STATUS="success"
              break
            else
              echo "âŒ Backend health check failed (attempt $i/3)"
              sleep 10
            fi
          done
          echo "status=$STATUS" >> $GITHUB_OUTPUT
          echo "::set-output name=status::$STATUS"
      - name: Check API endpoints
        id: api-health
        run: |
          PROD_URL="https://agrotmsol.com.br"
          ENDPOINTS=("/api/health" "/health" "/")
          STATUS="failed"
          for endpoint in "${ENDPOINTS[@]}"; do
            echo "ðŸ” Checking endpoint: $endpoint"
            if curl -f -s --max-time 30 "$PROD_URL$endpoint" > /dev/null; then
              echo "âœ… $endpoint is healthy"
              STATUS="success"
              break
            else
              echo "âŒ $endpoint is unhealthy"
            fi
          done
          echo "status=$STATUS" >> $GITHUB_OUTPUT
          echo "::set-output name=status::$STATUS"
      - name: Check additional endpoints
        id: additional-api-health
        run: |
          PROD_URL="https://agrotmsol.com.br"
          ADDITIONAL_ENDPOINTS=("/api/stats" "/api/pools" "/api/defi/apr")
          for endpoint in "${ADDITIONAL_ENDPOINTS[@]}"; do
            echo "ðŸ” Checking additional endpoint: $endpoint"
            if curl -f -s --max-time 30 "$PROD_URL$endpoint" > /dev/null; then
              echo "âœ… $endpoint is healthy"
            else
              echo "âš ï¸ $endpoint is unhealthy (non-critical)"
            fi
          done
      - name: Check response times
        id: response-times
        run: |
          PROD_URL="https://agrotmsol.com.br"
          echo "â±ï¸ Checking response times..."
          RESPONSE_TIME=$(curl -w "%{time_total}" -s -o /dev/null "$PROD_URL" 2>/dev/null)
          STATUS="failed"
          if [ ! -z "$RESPONSE_TIME" ]; then
            echo "Response time: ${RESPONSE_TIME}s"
            RESPONSE_TIME_FLOAT=$(echo "$RESPONSE_TIME" | bc -l 2>/dev/null || echo "0")
            if (( $(echo "$RESPONSE_TIME_FLOAT < 2.0" | bc -l) )); then
              echo "âœ… Response time is acceptable (< 2s)"
              STATUS="success"
            else
              echo "âš ï¸ Response time is slow (> 2s): ${RESPONSE_TIME}s"
              STATUS="slow"
            fi
          else
            echo "âŒ Could not measure response time"
          fi
          echo "status=$STATUS" >> $GITHUB_OUTPUT
          echo "::set-output name=status::$STATUS"

  notify-failure:
    runs-on: ubuntu-latest
    needs: health-check
    if: |
      needs.health-check.result == 'failure' ||
      needs.health-check.outputs.frontend-health-status == 'failed' ||
      needs.health-check.outputs.backend-health-status == 'failed' ||
      needs.health-check.outputs.api-health-status == 'failed'
    steps:
      - name: Send failure notification
        run: |
          echo "ðŸš¨ Health check failed! Sending notification..."
          FRONTEND_STATUS="${{ needs.health-check.outputs.frontend-health-status }}"
          BACKEND_STATUS="${{ needs.health-check.outputs.backend-health-status }}"
          API_STATUS="${{ needs.health-check.outputs.api-health-status }}"
          RESPONSE_TIME_STATUS="${{ needs.health-check.outputs.response-times-status }}"
          if [ -n "${{ env.NOTIFICATION_WEBHOOK_URL }}" ] && [ "${{ env.NOTIFICATION_WEBHOOK_URL }}" != "https://hooks.slack.com/services/dummy/dummy/dummy" ]; then
            PAYLOAD='{"content":"ðŸš¨ AGROTM.SOL Health Check Failed!","embeds":[{"title":"Production Health Check Alert","color":15158332,"fields":[{"name":"Frontend Status","value":"'$FRONTEND_STATUS'","inline":true},{"name":"Backend Status","value":"'$BACKEND_STATUS'","inline":true},{"name":"API Status","value":"'$API_STATUS'","inline":true},{"name":"Response Time","value":"'$RESPONSE_TIME_STATUS'","inline":true},{"name":"Environment","value":"Production","inline":true},{"name":"URL","value":"https://agrotmsol.com.br","inline":true}],"timestamp":"'$(date -u +%Y-%m-%dT%H:%M:%SZ)'"}]}'
            curl -H "Content-Type: application/json" -d "$PAYLOAD" "${{ env.NOTIFICATION_WEBHOOK_URL }}"
          fi

  generate-report:
    runs-on: ubuntu-latest
    needs: health-check
    if: always()
    steps:
      - name: Generate monitoring report
        run: |
          echo "ðŸ“Š AGROTM.SOL Monitoring Report" > monitoring-report.md
          echo "===============================" >> monitoring-report.md
          echo "" >> monitoring-report.md
          echo "**Date:** $(date)" >> monitoring-report.md
          echo "**Environment:** Production" >> monitoring-report.md
          echo "**URL:** https://agrotmsol.com.br" >> monitoring-report.md
          echo "" >> monitoring-report.md
          
          echo "## Health Check Results:" >> monitoring-report.md
          echo "- Frontend: ${{ needs.health-check.outputs.frontend-health-status }}" >> monitoring-report.md
          echo "- Backend: ${{ needs.health-check.outputs.backend-health-status }}" >> monitoring-report.md
          echo "- API: ${{ needs.health-check.outputs.api-health-status }}" >> monitoring-report.md
          echo "- Response Time: ${{ needs.health-check.outputs.response-times-status }}" >> monitoring-report.md
          echo "" >> monitoring-report.md
          
          echo "## Status:" >> monitoring-report.md
          if [ "${{ needs.health-check.result }}" = "success" ]; then
            echo "âœ… All systems operational" >> monitoring-report.md
          else
            echo "âŒ Issues detected" >> monitoring-report.md
          fi

      - name: Upload monitoring report
        uses: actions/upload-artifact@v4
        with:
          name: monitoring-report
          path: monitoring-report.md
