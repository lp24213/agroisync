name: AGROTM.SOL Production Monitoring

on:
  schedule:
    # Run every 5 minutes
    - cron: '*/5 * * * *'
  workflow_dispatch:

env:
  VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
  VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID_PROD }}
  BACKEND_URL: ${{ secrets.BACKEND_URL }}
  NOTIFICATION_WEBHOOK_URL: ${{ secrets.NOTIFICATION_WEBHOOK_URL }}

jobs:
  health-check:
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - name: Check frontend health
        id: frontend-health
        run: |
          # Use the production URL directly since we know it
          PROD_URL="https://agrotmsol.com.br"

          echo "Checking frontend health: $PROD_URL"

          # Health check with timeout and retries
          for i in {1..3}; do
            if curl -f -s --max-time 30 "$PROD_URL" > /dev/null; then
              echo "✅ Frontend health check passed"
              echo "status=success" >> $GITHUB_OUTPUT
              break
            else
              echo "❌ Frontend health check failed (attempt $i/3)"
              if [ $i -eq 3 ]; then
                echo "status=failed" >> $GITHUB_OUTPUT
              fi
              sleep 10
            fi
          done

      - name: Check backend health
        id: backend-health
        run: |
          # Check backend health endpoint
          BACKEND_URL="${{ env.BACKEND_URL }}"

          if [ -z "$BACKEND_URL" ]; then
            echo "⚠️ Backend URL not configured, skipping backend health check"
            echo "status=skipped" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Checking backend health: $BACKEND_URL/health"

          # Health check with timeout and retries
          for i in {1..3}; do
            if curl -f -s --max-time 30 "$BACKEND_URL/health" > /dev/null; then
              echo "✅ Backend health check passed"
              echo "status=success" >> $GITHUB_OUTPUT
              break
            else
              echo "❌ Backend health check failed (attempt $i/3)"
              if [ $i -eq 3 ]; then
                echo "status=failed" >> $GITHUB_OUTPUT
              fi
              sleep 10
            fi
          done

      - name: Check API endpoints
        id: api-health
        run: |
          # Use the production URL directly since we know it
          PROD_URL="https://agrotmsol.com.br"

          # Check critical endpoints
          ENDPOINTS=("/api/health" "/health" "/")

          for endpoint in "${ENDPOINTS[@]}"; do
            echo "Checking endpoint: $endpoint"
            if curl -f -s --max-time 30 "$PROD_URL$endpoint" > /dev/null; then
              echo "✅ $endpoint is healthy"
              echo "status=success" >> $GITHUB_OUTPUT
              break
            else
              echo "❌ $endpoint is unhealthy"
            fi
          done

          # If no endpoint worked, mark as failed
          if [ ! -f "$GITHUB_OUTPUT" ] || ! grep -q "status=" "$GITHUB_OUTPUT"; then
            echo "status=failed" >> $GITHUB_OUTPUT
          fi

      - name: Check additional endpoints (optional)
        id: additional-api-health
        run: |
          # Use the production URL directly since we know it
          PROD_URL="https://agrotmsol.com.br"

          # Check additional endpoints that might not exist yet
          ADDITIONAL_ENDPOINTS=("/api/defi/pools" "/api/stats/overview")

          for endpoint in "${ADDITIONAL_ENDPOINTS[@]}"; do
            echo "Checking additional endpoint: $endpoint"
            if curl -f -s --max-time 30 "$PROD_URL$endpoint" > /dev/null; then
              echo "✅ $endpoint is healthy"
            else
              echo "⚠️ $endpoint is not available (this is normal for new deployments)"
            fi
          done

          echo "status=success" >> $GITHUB_OUTPUT

      - name: Send health report
        run: |
          FRONTEND_STATUS="${{ steps.frontend-health.outputs.status }}"
          BACKEND_STATUS="${{ steps.backend-health.outputs.status }}"
          API_STATUS="${{ steps.api-health.outputs.status }}"
          ADDITIONAL_API_STATUS="${{ steps.additional-api-health.outputs.status }}"

          echo "Health Report:"
          echo "- Frontend: $FRONTEND_STATUS"
          echo "- Backend: $BACKEND_STATUS"
          echo "- API: $API_STATUS"
          echo "- Additional API: $ADDITIONAL_API_STATUS"

          # Send notification if webhook is configured
          if [ ! -z "${{ env.NOTIFICATION_WEBHOOK_URL }}" ] && [ "${{ env.NOTIFICATION_WEBHOOK_URL }}" != "https://hooks.slack.com/services/dummy/dummy/dummy" ]; then
            if [ "$FRONTEND_STATUS" = "failed" ] || [ "$BACKEND_STATUS" = "failed" ] || [ "$API_STATUS" = "failed" ]; then
              curl -H "Content-Type: application/json" \
                -d "{\"content\":\"⚠️ AGROTM Health Check Failed\\nFrontend: $FRONTEND_STATUS\\nBackend: $BACKEND_STATUS\\nAPI: $API_STATUS\"}" \
                "${{ env.NOTIFICATION_WEBHOOK_URL }}" || echo "⚠️ Failed to send notification"
            fi
          fi

          # Don't fail the workflow even if health checks fail
          if [ "$FRONTEND_STATUS" = "failed" ] || [ "$BACKEND_STATUS" = "failed" ] || [ "$API_STATUS" = "failed" ]; then
            echo "⚠️ Some health checks failed, but continuing workflow"
            exit 0
          fi
