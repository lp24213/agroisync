name: Deploy to GCP

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging
          - development

env:
  GCP_PROJECT_ID: agrotm-project
  GCP_REGION: us-central1
  GCP_CLUSTER: agrotm-cluster
  GCP_SERVICE: agrotm-service

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'production' }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Google Auth
      uses: google-github-actions/auth@v1
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}
        project_id: ${{ env.GCP_PROJECT_ID }}
        
    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v1
      with:
        project_id: ${{ env.GCP_PROJECT_ID }}
        
    - name: Configure Docker for GCR
      run: gcloud auth configure-docker
      
    - name: Build and push to Google Container Registry
      run: |
        docker build -t gcr.io/${{ env.GCP_PROJECT_ID }}/${{ env.GCP_SERVICE }}:${{ github.sha }} .
        docker build -t gcr.io/${{ env.GCP_PROJECT_ID }}/${{ env.GCP_SERVICE }}:latest .
        docker push gcr.io/${{ env.GCP_PROJECT_ID }}/${{ env.GCP_SERVICE }}:${{ github.sha }}
        docker push gcr.io/${{ env.GCP_PROJECT_ID }}/${{ env.GCP_SERVICE }}:latest
        
    - name: Deploy to Cloud Run
      run: |
        gcloud run deploy ${{ env.GCP_SERVICE }} \
          --image gcr.io/${{ env.GCP_PROJECT_ID }}/${{ env.GCP_SERVICE }}:${{ github.sha }} \
          --platform managed \
          --region ${{ env.GCP_REGION }} \
          --allow-unauthenticated \
          --port 3000 \
          --memory 2Gi \
          --cpu 2 \
          --max-instances 10 \
          --min-instances 1 \
          --set-env-vars NODE_ENV=production
          
    - name: Update Load Balancer
      run: |
        # Update Cloud Load Balancer backend
        gcloud compute backend-services update ${{ env.GCP_SERVICE }}-backend \
          --global \
          --enable-cdn
          
    - name: Update DNS
      run: |
        # Update Cloud DNS records
        gcloud dns record-sets update a www.agrotm.com \
          --zone=agrotm-zone \
          --rrdatas=${{ secrets.GCP_APP_IP }}
      if: ${{ github.event.inputs.environment == 'production' }}
      
    - name: Run health checks
      run: |
        # Wait for application to be healthy
        sleep 30
        
        # Get the service URL
        SERVICE_URL=$(gcloud run services describe ${{ env.GCP_SERVICE }} \
          --platform managed \
          --region ${{ env.GCP_REGION }} \
          --format="value(status.url)")
          
        # Run health checks
        curl -f $SERVICE_URL/health || exit 1
        
        # Run smoke tests
        npm run test:smoke
        
    - name: Scale up application
      run: |
        # Scale up the Cloud Run service
        gcloud run services update ${{ env.GCP_SERVICE }} \
          --platform managed \
          --region ${{ env.GCP_REGION }} \
          --min-instances 2 \
          --max-instances 10
          
    - name: Monitor deployment
      run: |
        # Monitor deployment for 5 minutes
        for i in {1..30}; do
          echo "Checking deployment status... ($i/30)"
          
          # Check service status
          SERVICE_STATUS=$(gcloud run services describe ${{ env.GCP_SERVICE }} \
            --platform managed \
            --region ${{ env.GCP_REGION }} \
            --format="value(status.conditions[0].status)")
            
          if [ "$SERVICE_STATUS" = "True" ]; then
            echo "Service is ready and healthy"
            break
          fi
          
          sleep 10
        done
        
        if [ "$SERVICE_STATUS" != "True" ]; then
          echo "Service failed to become ready"
          exit 1
        fi
        
    - name: Run post-deployment tests
      run: |
        # Run integration tests
        npm run test:integration
        
        # Run performance tests
        npm run test:performance
        
        # Run security tests
        npm run test:security
        
    - name: Update deployment status
      run: |
        # Update deployment status in database
        curl -X POST ${{ secrets.DEPLOYMENT_WEBHOOK_URL }} \
          -H "Content-Type: application/json" \
          -d "{\"status\": \"success\", \"environment\": \"${{ github.event.inputs.environment || 'production' }}\", \"commit\": \"${{ github.sha }}\", \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"}"
          
    - name: Create deployment record
      run: |
        # Create deployment record in monitoring system
        gcloud logging write agrotm-deployments \
          "Deployment successful: ${{ github.sha }} to ${{ github.event.inputs.environment || 'production' }}" \
          --severity=INFO
          
    - name: Notify deployment success
      uses: 8398a7/action-slack@v3
      with:
        status: success
        channel: '#deployments'
        webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
        text: |
          ✅ GCP deployment successful!
          Environment: ${{ github.event.inputs.environment || 'production' }}
          Commit: ${{ github.sha }}
          URL: ${{ secrets.GCP_APP_URL }}
      if: success()
      
    - name: Notify deployment failure
      uses: 8398a7/action-slack@v3
      with:
        status: failure
        channel: '#deployments'
        webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
        text: |
          ❌ GCP deployment failed!
          Environment: ${{ github.event.inputs.environment || 'production' }}
          Commit: ${{ github.sha }}
          Check the logs for details.
      if: failure()
      
    - name: Rollback on failure
      run: |
        # Rollback to previous revision if deployment fails
        PREVIOUS_REVISION=$(gcloud run revisions list \
          --service=${{ env.GCP_SERVICE }} \
          --platform managed \
          --region ${{ env.GCP_REGION }} \
          --format="value(metadata.name)" \
          --limit=2 | tail -n 1)
          
        gcloud run services update-traffic ${{ env.GCP_SERVICE }} \
          --platform managed \
          --region ${{ env.GCP_REGION }} \
          --to-revisions=$PREVIOUS_REVISION=100
          
        echo "Rolled back to previous revision"
      if: failure()
      
    - name: Clean up old images
      run: |
        # Keep only last 10 images
        gcloud container images list-tags gcr.io/${{ env.GCP_PROJECT_ID }}/${{ env.GCP_SERVICE }} \
          --format="value(digest)" \
          --limit=10 \
          --sort-by=~timestamp | \
        tail -n +11 | \
        xargs -I {} gcloud container images delete gcr.io/${{ env.GCP_PROJECT_ID }}/${{ env.GCP_SERVICE }}@{} --quiet 