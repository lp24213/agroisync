name: Security Audit

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    - cron: '0 2 * * 1' # Every Monday at 2 AM

env:
  NODE_ENV: test
  JWT_SECRET: ${{ secrets.JWT_SECRET }}
  MONGODB_URI: ${{ secrets.MONGODB_URI }}
  VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
  VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID_PROD }}
  RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

jobs:
  dependency-scan:
    name: Dependency Security Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: '8'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run pnpm audit
        run: |
          pnpm audit --audit-level=moderate || {
            echo "⚠️ Security vulnerabilities found. Review the report above."
            exit 0  # Don't fail the build for moderate vulnerabilities
          }

      - name: Run npm audit
        run: |
          npm audit --audit-level=moderate || {
            echo "⚠️ NPM audit found vulnerabilities. Review the report above."
            exit 0  # Don't fail the build for moderate vulnerabilities
          }

  code-security:
    name: Code Security Analysis
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: '8'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run ESLint security rules
        run: pnpm lint

      - name: Run TypeScript type checking
        run: pnpm type-check

      - name: Check for hardcoded secrets
        run: |
          # Check for potential secrets in code
          if grep -r "password\|secret\|key\|token" --include="*.js" --include="*.ts" --include="*.json" . | grep -v "node_modules" | grep -v ".git" | grep -v "package.json" | grep -v "package-lock.json" | grep -v "pnpm-lock.yaml"; then
            echo "⚠️ Potential secrets found in code. Please review."
            exit 0  # Don't fail the build
          else
            echo "✅ No obvious secrets found in code"
          fi

  container-security:
    name: Container Security
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'

      - name: Upload Trivy scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  secret-scanning:
    name: Secret Scanning
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run TruffleHog
        run: |
          # Install TruffleHog
          curl -sSfL https://raw.githubusercontent.com/trufflesecurity/trufflehog/main/scripts/install.sh | sh -s -- -b /usr/local/bin

          # Run scan
          trufflehog --only-verified --fail . || {
            echo "⚠️ TruffleHog found potential secrets. Review the output above."
            exit 0  # Don't fail the build
          }

  smart-contract-security:
    name: Smart Contract Security
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable

      - name: Install cargo-audit
        run: cargo install cargo-audit

      - name: Run cargo audit
        run: |
          cd contracts
          cargo audit || {
            echo "⚠️ Cargo audit found vulnerabilities. Review the report above."
            exit 0  # Don't fail the build
          }

  security-report:
    name: Generate Security Report
    runs-on: ubuntu-latest
    needs: [dependency-scan, code-security, container-security, secret-scanning]
    if: always()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate security summary
        run: |
          echo "# Security Audit Summary" > security-report.md
          echo "Generated on: $(date)" >> security-report.md
          echo "" >> security-report.md
          echo "## Dependency Scan" >> security-report.md
          echo "- Status: ${{ needs.dependency-scan.result }}" >> security-report.md
          echo "" >> security-report.md
          echo "## Code Security" >> security-report.md
          echo "- Status: ${{ needs.code-security.result }}" >> security-report.md
          echo "" >> security-report.md
          echo "## Container Security" >> security-report.md
          echo "- Status: ${{ needs.container-security.result }}" >> security-report.md
          echo "" >> security-report.md
          echo "## Secret Scanning" >> security-report.md
          echo "- Status: ${{ needs.secret-scanning.result }}" >> security-report.md

      - name: Upload security report
        uses: actions/upload-artifact@v3
        with:
          name: security-report
          path: security-report.md
