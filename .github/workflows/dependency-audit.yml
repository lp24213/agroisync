name: Dependency Audit

on:
  schedule:
    - cron: '0 6 * * *'  # Daily at 6 AM UTC
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  audit:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18.17.0'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Run npm audit
      run: npm audit --audit-level=moderate
      continue-on-error: true
      
    - name: Run npm audit (JSON output)
      run: npm audit --audit-level=moderate --json > audit-report.json
      continue-on-error: true
      
    - name: Run Snyk security scan
      uses: snyk/actions/node@master
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
      with:
        args: --severity-threshold=high --json-file-output=snyk-report.json
      continue-on-error: true
      
    - name: Run OWASP Dependency Check
      uses: dependency-check/Dependency-Check_Action@main
      with:
        project: 'AGROTM Solana'
        path: '.'
        format: 'HTML'
        out: 'reports'
        args: >
          --failOnCVSS 7
          --enableRetired
          --enableExperimental
      continue-on-error: true
      
    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'
        severity: 'HIGH,CRITICAL'
      continue-on-error: true
      
    - name: Upload Trivy scan results to GitHub Security tab
      uses: github/codeql-action/upload-sarif@v2
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'
        
    - name: Run Safety (Python dependencies)
      run: |
        pip install safety
        safety check --json --output safety-report.json
      continue-on-error: true
      
    - name: Run Cargo audit (Rust dependencies)
      run: |
        if [ -f "Cargo.toml" ]; then
          cargo install cargo-audit
          cargo audit --json > cargo-audit-report.json
        fi
      continue-on-error: true
      
    - name: Run Composer audit (PHP dependencies)
      run: |
        if [ -f "composer.json" ]; then
          composer audit --format=json > composer-audit-report.json
        fi
      continue-on-error: true
      
    - name: Run Maven dependency check (Java dependencies)
      run: |
        if [ -f "pom.xml" ]; then
          mvn org.owasp:dependency-check-maven:check \
            -Dformat=JSON \
            -DoutputDirectory=reports \
            -DoutputFileName=maven-audit-report.json
        fi
      continue-on-error: true
      
    - name: Run Gradle dependency check (Java dependencies)
      run: |
        if [ -f "build.gradle" ]; then
          ./gradlew dependencyCheckAnalyze \
            --dependency-check-format=JSON \
            --dependency-check-outputDirectory=reports \
            --dependency-check-outputFileName=gradle-audit-report.json
        fi
      continue-on-error: true
      
    - name: Run NuGet audit (.NET dependencies)
      run: |
        if [ -f "*.csproj" ]; then
          dotnet list package --vulnerable --format json > dotnet-audit-report.json
        fi
      continue-on-error: true
      
    - name: Run Bundler audit (Ruby dependencies)
      run: |
        if [ -f "Gemfile" ]; then
          bundle audit check --format json > bundler-audit-report.json
        fi
      continue-on-error: true
      
    - name: Run Go mod audit (Go dependencies)
      run: |
        if [ -f "go.mod" ]; then
          go list -json -deps ./... | \
          jq -r 'select(.Vulnerabilities != null) | .Path + ": " + (.Vulnerabilities | map(.ID) | join(", "))' > go-audit-report.json
        fi
      continue-on-error: true
      
    - name: Generate audit summary
      run: |
        echo "# Security Audit Summary" > audit-summary.md
        echo "" >> audit-summary.md
        echo "**Date:** $(date)" >> audit-summary.md
        echo "**Repository:** ${{ github.repository }}" >> audit-summary.md
        echo "**Branch:** ${{ github.ref_name }}" >> audit-summary.md
        echo "" >> audit-summary.md
        
        # NPM Audit Summary
        if [ -f "audit-report.json" ]; then
          echo "## NPM Audit" >> audit-summary.md
          npm audit --audit-level=moderate --parseable | \
          awk -F'\t' '{print "- " $2 " (" $3 "): " $4}' >> audit-summary.md
          echo "" >> audit-summary.md
        fi
        
        # Snyk Summary
        if [ -f "snyk-report.json" ]; then
          echo "## Snyk Security Scan" >> audit-summary.md
          jq -r '.vulnerabilities[] | "- " + .title + " (" + .severity + "): " + .description' snyk-report.json >> audit-summary.md
          echo "" >> audit-summary.md
        fi
        
        # Trivy Summary
        if [ -f "trivy-results.sarif" ]; then
          echo "## Trivy Vulnerability Scan" >> audit-summary.md
          jq -r '.runs[0].results[] | "- " + .rule.id + " (" + .level + "): " + .message.text' trivy-results.sarif >> audit-summary.md
          echo "" >> audit-summary.md
        fi
        
        # Other language summaries
        for report in safety-report.json cargo-audit-report.json composer-audit-report.json maven-audit-report.json gradle-audit-report.json dotnet-audit-report.json bundler-audit-report.json go-audit-report.json; do
          if [ -f "$report" ]; then
            echo "## $(basename $report .json | sed 's/-audit-report//' | sed 's/-/ /g' | sed 's/\b\w/\U&/g')" >> audit-summary.md
            jq -r '.[] | "- " + .title + " (" + .severity + "): " + .description' "$report" >> audit-summary.md 2>/dev/null || echo "No vulnerabilities found" >> audit-summary.md
            echo "" >> audit-summary.md
          fi
        done
        
    - name: Upload audit reports
      uses: actions/upload-artifact@v3
      with:
        name: security-audit-reports
        path: |
          audit-summary.md
          audit-report.json
          snyk-report.json
          trivy-results.sarif
          safety-report.json
          cargo-audit-report.json
          composer-audit-report.json
          maven-audit-report.json
          gradle-audit-report.json
          dotnet-audit-report.json
          bundler-audit-report.json
          go-audit-report.json
          reports/
        retention-days: 30
        
    - name: Create security issue for high/critical vulnerabilities
      run: |
        # Check for high/critical vulnerabilities
        if [ -f "audit-report.json" ]; then
          HIGH_VULNS=$(jq -r '.metadata.vulnerabilities.high // 0' audit-report.json)
          CRITICAL_VULNS=$(jq -r '.metadata.vulnerabilities.critical // 0' audit-report.json)
          
          if [ "$HIGH_VULNS" -gt 0 ] || [ "$CRITICAL_VULNS" -gt 0 ]; then
            echo "Found $HIGH_VULNS high and $CRITICAL_VULNS critical vulnerabilities"
            echo "Creating security issue..."
            
            gh issue create \
              --title "ðŸš¨ Security Vulnerabilities Detected" \
              --body "High: $HIGH_VULNS, Critical: $CRITICAL_VULNS vulnerabilities found in dependencies. Please review the audit reports." \
              --label "security,high-priority" \
              --assignee "agrotm-security-team"
          fi
        fi
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      continue-on-error: true
      
    - name: Notify security team
      uses: 8398a7/action-slack@v3
      with:
        status: ${{ job.status }}
        channel: '#security'
        webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
        text: |
          Security audit completed for ${{ github.repository }}
          Branch: ${{ github.ref_name }}
          Check the audit reports for details.
      if: always() 