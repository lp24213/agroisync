name: AGROTM.SOL Manual Rollback

on:
  workflow_dispatch:
    inputs:
      deployment_id:
        description: 'Deployment ID to rollback to (optional, will use previous if not provided)'
        required: false
        type: string
      environment:
        description: 'Environment to rollback'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - preview

env:
  VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
  VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID_PROD }}
  RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
  RAILWAY_SERVICE: agrotm-backend
  NOTIFICATION_WEBHOOK_URL: ${{ secrets.NOTIFICATION_WEBHOOK_URL }}

jobs:
  rollback:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Get deployment ID
        id: get-deployment
        run: |
          if [ ! -z "${{ github.event.inputs.deployment_id }}" ]; then
            DEPLOYMENT_ID="${{ github.event.inputs.deployment_id }}"
            echo "Using provided deployment ID: $DEPLOYMENT_ID"
          else
            # Get the previous deployment ID
            DEPLOYMENT_ID=$(curl -s -H "Authorization: Bearer ${{ env.VERCEL_TOKEN }}" \
              "https://api.vercel.com/v1/deployments?teamId=${{ env.VERCEL_ORG_ID }}&projectId=${{ env.VERCEL_PROJECT_ID }}&limit=2" | \
              jq -r '.deployments[1].id // empty')
            echo "Using previous deployment ID: $DEPLOYMENT_ID"
          fi

          if [ -z "$DEPLOYMENT_ID" ]; then
            echo "‚ùå No deployment ID found for rollback"
            exit 1
          fi

          echo "deployment_id=$DEPLOYMENT_ID" >> $GITHUB_OUTPUT

      - name: Verify deployment exists
        run: |
          DEPLOYMENT_ID="${{ steps.get-deployment.outputs.deployment_id }}"

          # Check if deployment exists and get its status
          DEPLOYMENT_INFO=$(curl -s -H "Authorization: Bearer ${{ env.VERCEL_TOKEN }}" \
            "https://api.vercel.com/v1/deployments/$DEPLOYMENT_ID")

          DEPLOYMENT_STATUS=$(echo "$DEPLOYMENT_INFO" | jq -r '.ready // false')
          DEPLOYMENT_URL=$(echo "$DEPLOYMENT_INFO" | jq -r '.url // empty')

          if [ "$DEPLOYMENT_STATUS" != "true" ]; then
            echo "‚ùå Deployment $DEPLOYMENT_ID is not ready for rollback"
            exit 1
          fi

          echo "‚úÖ Deployment $DEPLOYMENT_ID is ready"
          echo "URL: $DEPLOYMENT_URL"

      - name: Rollback frontend to Vercel
        run: |
          DEPLOYMENT_ID="${{ steps.get-deployment.outputs.deployment_id }}"
          ENVIRONMENT="${{ github.event.inputs.environment }}"

          echo "üîÑ Rolling back frontend to deployment $DEPLOYMENT_ID in $ENVIRONMENT environment..."

          if [ "$ENVIRONMENT" = "production" ]; then
            # Promote to production
            RESPONSE=$(curl -s -w "%{http_code}" -X POST \
              -H "Authorization: Bearer ${{ env.VERCEL_TOKEN }}" \
              "https://api.vercel.com/v1/deployments/$DEPLOYMENT_ID/promote")

            HTTP_CODE="${RESPONSE: -3}"
            RESPONSE_BODY="${RESPONSE%???}"

            if [ "$HTTP_CODE" = "200" ]; then
              echo "‚úÖ Frontend rollback completed successfully!"
            else
              echo "‚ùå Frontend rollback failed with HTTP $HTTP_CODE"
              echo "Response: $RESPONSE_BODY"
              exit 1
            fi
          else
            # For preview, we can't promote, but we can get the URL
            DEPLOYMENT_URL=$(curl -s -H "Authorization: Bearer ${{ env.VERCEL_TOKEN }}" \
              "https://api.vercel.com/v1/deployments/$DEPLOYMENT_ID" | \
              jq -r '.url // empty')
            echo "Preview deployment available at: $DEPLOYMENT_URL"
          fi

      - name: Rollback backend to Railway
        run: |
          ENVIRONMENT="${{ github.event.inputs.environment }}"

          echo "üîÑ Rolling back backend to Railway..."

          SERVICE_NAME="${{ env.RAILWAY_SERVICE }}"

          # Trigger a new deployment to rollback (Railway doesn't have direct rollback API)
          RESPONSE=$(curl -s -w "%{http_code}" -X POST \
            -H "Authorization: Bearer ${{ env.RAILWAY_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d "{\"service\": \"$SERVICE_NAME\"}" \
            https://api.railway.app/v2/deployments)

          HTTP_CODE="${RESPONSE: -3}"
          RESPONSE_BODY="${RESPONSE%???}"

          if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "201" ]; then
            echo "‚úÖ Backend rollback triggered successfully!"
          else
            echo "‚ùå Backend rollback failed with HTTP $HTTP_CODE"
            echo "Response: $RESPONSE_BODY"
            exit 1
          fi

      - name: Health check after rollback
        if: github.event.inputs.environment == 'production'
        run: |
          # Wait a bit for the rollback to propagate
          sleep 30

          # Use the production URL directly since we know it
          PROD_URL="https://agrotmsol.com.br"

          echo "Running health check on: $PROD_URL"

          # Try multiple health check endpoints
          if curl -f -s --max-time 30 "$PROD_URL/api/health" > /dev/null; then
            echo "‚úÖ Health check passed at /api/health"
          elif curl -f -s --max-time 30 "$PROD_URL/health" > /dev/null; then
            echo "‚úÖ Health check passed at /health"
          elif curl -f -s --max-time 30 "$PROD_URL/" > /dev/null; then
            echo "‚úÖ Health check passed at root /"
          else
            echo "‚ö†Ô∏è Health check failed after rollback, but deployment might still be processing"
            echo "This is normal for rollbacks that take time to propagate"
          fi

      - name: Notify rollback success
        run: |
          echo "‚úÖ Rollback completed successfully!"

          # Send notification if webhook is configured
          if [ ! -z "${{ env.NOTIFICATION_WEBHOOK_URL }}" ] && [ "${{ env.NOTIFICATION_WEBHOOK_URL }}" != "https://hooks.slack.com/services/dummy/dummy/dummy" ]; then
            curl -H "Content-Type: application/json" \
              -d '{"content":"‚úÖ AGROTM rollback completed successfully!"}' \
              "${{ env.NOTIFICATION_WEBHOOK_URL }}"
          fi

      - name: Notify rollback failure
        if: failure()
        run: |
          echo "‚ùå Rollback failed!"

          # Send notification if webhook is configured
          if [ ! -z "${{ env.NOTIFICATION_WEBHOOK_URL }}" ] && [ "${{ env.NOTIFICATION_WEBHOOK_URL }}" != "https://hooks.slack.com/services/dummy/dummy/dummy" ]; then
            curl -H "Content-Type: application/json" \
              -d '{"content":"‚ùå AGROTM rollback failed!"}' \
              "${{ env.NOTIFICATION_WEBHOOK_URL }}"
          fi
