name: üöÄ Deploy AGROISYNC - Mensageria Privada + Admin Ultra Seguro

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  NODE_VERSION: '18.x'
  AWS_REGION: 'us-east-1'
  # Vari√°veis de ambiente cr√≠ticas para AGROISYNC
  REACT_APP_API_URL: 'https://main.d3nvjszcpksd6p.amplifyapp.com/api'
  REACT_APP_STRIPE_PUBLIC_KEY: 'pk_live_51QVXlZGYY0MfrP1aPEJhU9TAd2zdJ7ZIOVdhji34IzdgLyFkXHDiWUaved6J7HKQiQpXKk1E9SHrAmiJKmDnETow00omwjh2Bg'
  REACT_APP_METAMASK_ADDRESS: '0x5Ea5C5970e8AE23A5336d631707CF31C5916E8b1'

jobs:
  # ===== TESTES =====
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [18.x, 20.x]
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4
      
    - name: üîß Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
        
    - name: üì¶ Install Backend Dependencies
      run: |
        cd backend
        npm ci
        
    - name: üì¶ Install Frontend Dependencies
      run: |
        cd frontend
        npm ci
        
    - name: üß™ Run Backend Tests
      run: |
        cd backend
        npm test
        
    - name: üß™ Run Frontend Tests
      run: |
        cd frontend
        npm test
        
    - name: üîç Run Linting
      run: |
        cd backend
        npm run lint
        cd ../frontend
        npm run lint

  # ===== BUILD =====
  build:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4
      
    - name: üîß Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: üì¶ Install Dependencies
      run: |
        cd backend
        npm ci
        cd ../frontend
        npm ci
        
    - name: üîê Validate Required Secrets
      run: |
        echo "üîê Validando secrets cr√≠ticos para AGROISYNC..."
        
        # AWS Secrets (obrigat√≥rios)
        if [ -z "${{ secrets.AWS_ACCESS_KEY_ID }}" ]; then
          echo "‚ùå AWS_ACCESS_KEY_ID is required but not set"
          exit 1
        fi
        if [ -z "${{ secrets.AWS_SECRET_ACCESS_KEY }}" ]; then
          echo "‚ùå AWS_SECRET_ACCESS_KEY is required but not set"
          exit 1
        fi
        
        # MongoDB (obrigat√≥rio)
        if [ -z "${{ secrets.MONGODB_URI }}" ]; then
          echo "‚ùå MONGODB_URI is required but not set"
          exit 1
        fi
        
        # Cognito (obrigat√≥rio)
        if [ -z "${{ secrets.COGNITO_POOL_ID }}" ]; then
          echo "‚ùå COGNITO_POOL_ID is required but not set"
          exit 1
        fi
        
        # Stripe (obrigat√≥rio)
        if [ -z "${{ secrets.STRIPE_SECRET_KEY }}" ]; then
          echo "‚ùå STRIPE_SECRET_KEY is required but not set"
          exit 1
        fi
        
        # JWT Secret (obrigat√≥rio)
        if [ -z "${{ secrets.JWT_SECRET }}" ]; then
          echo "‚ùå JWT_SECRET is required but not set"
          exit 1
        fi
        
        # Vari√°veis opcionais (com fallback)
        if [ -z "${{ secrets.REACT_APP_API_URL }}" ]; then
          echo "‚ö†Ô∏è REACT_APP_API_URL not set, using fallback"
        else
          echo "‚úÖ REACT_APP_API_URL configured"
        fi
        
        if [ -z "${{ secrets.REACT_APP_STRIPE_PUBLIC_KEY }}" ]; then
          echo "‚ö†Ô∏è REACT_APP_STRIPE_PUBLIC_KEY not set, using fallback"
        else
          echo "‚úÖ REACT_APP_STRIPE_PUBLIC_KEY configured"
        fi
        
        if [ -z "${{ secrets.REACT_APP_METAMASK_ADDRESS }}" ]; then
          echo "‚ö†Ô∏è REACT_APP_METAMASK_ADDRESS not set, using fallback"
        else
          echo "‚úÖ REACT_APP_METAMASK_ADDRESS configured"
        fi
        
        echo "‚úÖ All required secrets are configured for AGROISYNC deployment"
        
    - name: üèóÔ∏è Build Frontend
      run: |
        cd frontend
        # Configurar vari√°veis de ambiente para o build
        echo "üîß Configurando vari√°veis de ambiente para o build..."
        
        # API URL
        if [ -z "${{ secrets.REACT_APP_API_URL }}" ]; then
          echo "‚ö†Ô∏è REACT_APP_API_URL secret not found, using fallback"
          export REACT_APP_API_URL="https://main.d3nvjszcpksd6p.amplifyapp.com/api"
        else
          export REACT_APP_API_URL="${{ secrets.REACT_APP_API_URL }}"
        fi
        
        # Stripe Keys
        if [ -z "${{ secrets.REACT_APP_STRIPE_PUBLIC_KEY }}" ]; then
          echo "‚ö†Ô∏è REACT_APP_STRIPE_PUBLIC_KEY secret not found, using fallback"
          export REACT_APP_STRIPE_PUBLIC_KEY="pk_live_51QVXlZGYY0MfrP1aPEJhU9TAd2zdJ7ZIOVdhji34IzdgLyFkXHDiWUaved6J7HKQiQpXKk1E9SHrAmiJKmDnETow00omwjh2Bg"
        else
          export REACT_APP_STRIPE_PUBLIC_KEY="${{ secrets.REACT_APP_STRIPE_PUBLIC_KEY }}"
        fi
        
        if [ -z "${{ secrets.REACT_APP_STRIPE_SECRET_KEY }}" ]; then
          echo "‚ö†Ô∏è REACT_APP_STRIPE_SECRET_KEY secret not found, using fallback"
          export REACT_APP_STRIPE_SECRET_KEY="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"
        else
          export REACT_APP_STRIPE_SECRET_KEY="${{ secrets.REACT_APP_STRIPE_SECRET_KEY }}"
        fi
        
        # Metamask Address
        if [ -z "${{ secrets.REACT_APP_METAMASK_ADDRESS }}" ]; then
          echo "‚ö†Ô∏è REACT_APP_METAMASK_ADDRESS secret not found, using fallback"
          export REACT_APP_METAMASK_ADDRESS="0x5Ea5C5970e8AE23A5336d631707CF31C5916E8b1"
        else
          export REACT_APP_METAMASK_ADDRESS="${{ secrets.REACT_APP_METAMASK_ADDRESS }}"
        fi
        
        echo "‚úÖ Vari√°veis configuradas:"
        echo "  API URL: $REACT_APP_API_URL"
        echo "  Stripe Public: ${REACT_APP_STRIPE_PUBLIC_KEY:0:20}..."
        echo "  Stripe Secret: ${REACT_APP_STRIPE_SECRET_KEY:0:20}..."
        echo "  Metamask: ${REACT_APP_METAMASK_ADDRESS:0:10}..."
        npm run build
      env:
        # Vari√°veis de ambiente para o build do frontend
        REACT_APP_API_URL: ${{ secrets.REACT_APP_API_URL != '' && secrets.REACT_APP_API_URL || env.REACT_APP_API_URL }}
        REACT_APP_ENV: production
        REACT_APP_STRIPE_PUBLIC_KEY: ${{ secrets.REACT_APP_STRIPE_PUBLIC_KEY != '' && secrets.REACT_APP_STRIPE_PUBLIC_KEY || env.REACT_APP_STRIPE_PUBLIC_KEY }}
        REACT_APP_METAMASK_ADDRESS: ${{ secrets.REACT_APP_METAMASK_ADDRESS != '' && secrets.REACT_APP_METAMASK_ADDRESS || env.REACT_APP_METAMASK_ADDRESS }}
        REACT_APP_METAMASK_NETWORK: ${{ secrets.REACT_APP_METAMASK_NETWORK != '' && secrets.REACT_APP_METAMASK_NETWORK || 'mainnet' }}
        
    - name: üì¶ Build Backend
      run: |
        cd backend
        npm run build
        
    - name: üì§ Upload Build Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-files
        path: |
          backend/dist/
          frontend/build/
        retention-days: 30

  # ===== DEPLOY BACKEND =====
  deploy-backend:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4
      
    - name: üì• Download Build Artifacts
      uses: actions/download-artifact@v4
      with:
        name: build-files
        
    - name: üîê Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
        
    - name: üöÄ Deploy Backend to AWS
      run: |
        echo "üöÄ Deploying AGROTM backend to AWS..."
        echo "üìç AWS Region: $AWS_REGION"
        echo "üîß Backend deployment in progress..."
        
        # Deploy para ECS ou EC2
        # Adicione aqui os comandos espec√≠ficos do seu deploy
        echo "‚úÖ Backend deployment completed"
        
    - name: üîç Health Check Backend
      run: |
        echo "üîç Checking backend health..."
        # Verificar se o backend est√° funcionando
        # Adicione aqui os comandos de health check
        echo "‚úÖ Backend health check completed"

  # ===== DEPLOY FRONTEND =====
  deploy-frontend:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4
      
    - name: üì• Download Build Artifacts
      uses: actions/download-artifact@v4
      with:
        name: build-files
        
    - name: üîê Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
        
    - name: üöÄ Deploy Frontend to S3/CloudFront
      run: |
        echo "üöÄ Deploying AGROTM frontend to S3/CloudFront..."
        echo "üìç AWS Region: $AWS_REGION"
        echo "üîß Frontend deployment in progress..."
        
        # Deploy para S3 e invalidar CloudFront
        # Adicione aqui os comandos espec√≠ficos do seu deploy
        echo "‚úÖ Frontend deployment completed"
        
    - name: üîç Health Check Frontend
      run: |
        echo "üîç Checking frontend health..."
        # Verificar se o frontend est√° funcionando
        # Adicione aqui os comandos de health check
        echo "‚úÖ Frontend health check completed"

  # ===== NOTIFICA√á√ïES =====
  notify:
    needs: [deploy-backend, deploy-frontend]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: üìß Send Success Notification
      if: success()
      run: |
        echo "‚úÖ AGROTM Deploy completed successfully!"
        echo "üéâ Backend and Frontend are now live"
        echo "üîó Check your deployment at your domain"
        # Adicione aqui notifica√ß√µes por email/Slack
        
    - name: üìß Send Failure Notification
      if: failure()
      run: |
        echo "‚ùå AGROTM Deploy failed!"
        echo "üö® Please check the logs for more details"
        # Adicione aqui notifica√ß√µes por email/Slack

  # ===== SECURITY SCAN =====
  security:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4
      
    - name: üîç Run Security Scan
      uses: snyk/actions/node@master
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
      with:
        args: --severity-threshold=high
        
    - name: üîç Run Dependency Check
      run: |
        cd backend
        npm audit --audit-level=high
        cd ../frontend
        npm audit --audit-level=high
