name: AGROISYNC Deploy

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  NODE_VERSION: '18'
  AWS_REGION: 'us-east-2'

jobs:
  # Frontend Tests & Build
  frontend:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./frontend
    
    steps:
    - name: ğŸš€ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸ“± Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
    
    - name: ğŸ“¦ Install dependencies
      run: npm ci
    
    - name: ğŸ” TypeScript check
      run: npm run type-check
    
    - name: ğŸ”§ Lint check
      run: npm run lint
    
    - name: ğŸ§ª Run tests
      run: npm test
    
    - name: ğŸ—ï¸ Build application
      run: npm run build
    
    - name: ğŸ“¦ Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: frontend-build
        path: frontend/.next
        retention-days: 1

  # Backend Tests & Build
  backend:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./backend
    
    steps:
    - name: ğŸš€ Checkout code
      uses: actions/checkout@v4
    
    - name: âš™ï¸ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: backend/package-lock.json
    
    - name: ğŸ“¦ Install dependencies
      run: npm ci
    
    - name: ğŸ” Lint check
      run: npm run lint
    
    - name: ğŸ§ª Run tests
      run: npm test
    
    - name: ğŸ”’ Security audit
      run: npm audit --audit-level=moderate
    
    - name: ğŸ“¦ Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: backend-build
        path: backend
        retention-days: 1

  # Deploy to AWS Amplify (Frontend)
  deploy-frontend:
    needs: [frontend, backend]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: ğŸš€ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸ”‘ Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
    
    - name: ğŸ“± Deploy Frontend to Amplify
      run: |
        # Get the Amplify App ID
        APP_ID=$(aws amplify list-apps --region ${{ env.AWS_REGION }} --query "apps[?name=='agroisync-frontend'].appId" --output text)
        
        if [ "$APP_ID" != "None" ]; then
          echo "ğŸš€ Deploying frontend to Amplify App: $APP_ID"
          
          # Create a new branch for deployment
          aws amplify create-branch \
            --app-id $APP_ID \
            --branch-name "deploy-$(date +%Y%m%d-%H%M%S)" \
            --region ${{ env.AWS_REGION }} || true
          
          # Start the build
          aws amplify start-job \
            --app-id $APP_ID \
            --branch-name main \
            --job-type RELEASE \
            --region ${{ env.AWS_REGION }}
        else
          echo "âš ï¸ Amplify App 'agroisync-frontend' not found"
        fi

  # Deploy to AWS Amplify (Backend)
  deploy-backend:
    needs: [frontend, backend]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: ğŸš€ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸ”‘ Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
    
    - name: âš™ï¸ Deploy Backend to Amplify
      run: |
        # Get the Amplify App ID
        APP_ID=$(aws amplify list-apps --region ${{ env.AWS_REGION }} --query "apps[?name=='agroisync-backend'].appId" --output text)
        
        if [ "$APP_ID" != "None" ]; then
          echo "ğŸš€ Deploying backend to Amplify App: $APP_ID"
          
          # Create a new branch for deployment
          aws amplify create-branch \
            --app-id $APP_ID \
            --branch-name "deploy-$(date +%Y%m%d-%H%M%S)" \
            --region ${{ env.AWS_REGION }} || true
          
          # Start the build
          aws amplify start-job \
            --app-id $APP_ID \
            --branch-name main \
            --job-type RELEASE \
            --region ${{ env.AWS_REGION }}
        else
          echo "âš ï¸ Amplify App 'agroisync-backend' not found"
        fi

  # Notify deployment status
  notify:
    needs: [deploy-frontend, deploy-backend]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: ğŸ“¢ Notify deployment status
      run: |
        if [ "${{ needs.deploy-frontend.result }}" == "success" ] && [ "${{ needs.deploy-backend.result }}" == "success" ]; then
          echo "ğŸ‰ Deployment successful!"
          echo "Frontend: âœ…"
          echo "Backend: âœ…"
        else
          echo "âŒ Deployment failed!"
          echo "Frontend: ${{ needs.deploy-frontend.result }}"
          echo "Backend: ${{ needs.deploy-backend.result }}"
          exit 1
        fi
