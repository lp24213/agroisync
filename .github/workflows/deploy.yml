name: ğŸš€ Deploy AGROISYNC - Mensageria Privada + Admin Ultra Seguro

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  NODE_VERSION: '18.x'
  AWS_REGION: 'us-east-1'
  # VariÃ¡veis de ambiente padrÃ£o para AGROISYNC
  REACT_APP_API_URL: 'https://main.d3nvjszcpksd6p.amplifyapp.com/api'
  REACT_APP_STRIPE_PUBLIC_KEY: 'pk_live_51QVXlZGYY0MfrP1aPEJhU9TAd2zdJ7ZIOVdhji34IzdgLyFkXHDiWUaved6J7HKQiQpXKk1E9SHrAmiJKmDnETow00omwjh2Bg'
  REACT_APP_METAMASK_ADDRESS: '0x5Ea5C5970e8AE23A5336d631707CF31C5916E8b1'
  REACT_APP_METAMASK_NETWORK: '1'

jobs:
  # ===== TESTES =====
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [18.x, 20.x]
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ”§ Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
        
    - name: ğŸ“¦ Install Backend Dependencies
      run: |
        cd backend
        npm ci
        
    - name: ğŸ“¦ Install Frontend Dependencies
      run: |
        cd frontend
        npm ci
        
    - name: ğŸ§ª Run Backend Tests
      run: |
        cd backend
        npm test
        
    - name: ğŸ§ª Run Frontend Tests
      run: |
        cd frontend
        npm test
        
    - name: ğŸ” Run Linting
      run: |
        cd backend
        npm run lint
        cd ../frontend
        npm run lint

  # ===== BUILD =====
  build:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: ğŸ“¦ Install Dependencies
      run: |
        cd backend
        npm ci
        cd ../frontend
        npm ci
        
    - name: ğŸ” Validate Required Secrets
      run: |
        echo "ğŸ” Validando secrets crÃ­ticos para AGROISYNC..."
        
        # AWS Secrets (obrigatÃ³rios)
        if [ -z "${{ secrets.AWS_ACCESS_KEY_ID }}" ]; then
          echo "âŒ AWS_ACCESS_KEY_ID is required but not set"
          exit 1
        fi
        if [ -z "${{ secrets.AWS_SECRET_ACCESS_KEY }}" ]; then
          echo "âŒ AWS_SECRET_ACCESS_KEY is required but not set"
          exit 1
        fi
        
        # MongoDB (obrigatÃ³rio)
        if [ -z "${{ secrets.MONGODB_URI }}" ]; then
          echo "âŒ MONGODB_URI is required but not set"
          exit 1
        fi
        
        # Cognito (obrigatÃ³rio)
        if [ -z "${{ secrets.COGNITO_POOL_ID }}" ]; then
          echo "âŒ COGNITO_POOL_ID is required but not set"
          exit 1
        fi
        
        # Stripe (obrigatÃ³rio)
        if [ -z "${{ secrets.STRIPE_SECRET_KEY }}" ]; then
          echo "âŒ STRIPE_SECRET_KEY is required but not set"
          exit 1
        fi
        
        # JWT Secret (obrigatÃ³rio)
        if [ -z "${{ secrets.JWT_SECRET }}" ]; then
          echo "âŒ JWT_SECRET is required but not set"
          exit 1
        fi
        
        echo "âœ… All required secrets are configured for AGROISYNC deployment"
        
    - name: ğŸ—ï¸ Build Frontend
      run: |
        cd frontend
        echo "ğŸ”§ Configurando variÃ¡veis de ambiente para o build..."
        
        # Configurar variÃ¡veis de ambiente usando valores padrÃ£o
        export REACT_APP_API_URL="${{ env.REACT_APP_API_URL }}"
        export REACT_APP_STRIPE_PUBLIC_KEY="${{ env.REACT_APP_STRIPE_PUBLIC_KEY }}"
        export REACT_APP_METAMASK_ADDRESS="${{ env.REACT_APP_METAMASK_ADDRESS }}"
        export REACT_APP_METAMASK_NETWORK="${{ env.REACT_APP_METAMASK_NETWORK }}"
        
        echo "âœ… VariÃ¡veis configuradas:"
        echo "  API URL: $REACT_APP_API_URL"
        echo "  Stripe Public: ${REACT_APP_STRIPE_PUBLIC_KEY:0:20}..."
        echo "  Metamask: ${REACT_APP_METAMASK_ADDRESS:0:10}..."
        echo "  Network: $REACT_APP_METAMASK_NETWORK"
        
        npm run build
      env:
        REACT_APP_API_URL: ${{ env.REACT_APP_API_URL }}
        REACT_APP_STRIPE_PUBLIC_KEY: ${{ env.REACT_APP_STRIPE_PUBLIC_KEY }}
        REACT_APP_METAMASK_ADDRESS: ${{ env.REACT_APP_METAMASK_ADDRESS }}
        REACT_APP_METAMASK_NETWORK: ${{ env.REACT_APP_METAMASK_NETWORK }}
        
    - name: ğŸ“¦ Build Backend
      run: |
        cd backend
        npm run build
        
    - name: ğŸ“¤ Upload Build Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-files
        path: |
          backend/dist/
          frontend/build/
        retention-days: 30

  # ===== DEPLOY BACKEND =====
  deploy-backend:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ“¥ Download Build Artifacts
      uses: actions/download-artifact@v4
      with:
        name: build-files
        
    - name: ğŸ” Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
        
    - name: ğŸš€ Deploy Backend to AWS
      run: |
        echo "ğŸš€ Deploying AGROTM backend to AWS..."
        echo "ğŸ“ AWS Region: $AWS_REGION"
        echo "ğŸ”§ Backend deployment in progress..."
        
        # Deploy para ECS ou EC2
        # Adicione aqui os comandos especÃ­ficos do seu deploy
        echo "âœ… Backend deployment completed"
        
    - name: ğŸ” Health Check Backend
      run: |
        echo "ğŸ” Checking backend health..."
        # Verificar se o backend estÃ¡ funcionando
        # Adicione aqui os comandos de health check
        echo "âœ… Backend health check completed"

  # ===== DEPLOY FRONTEND =====
  deploy-frontend:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ“¥ Download Build Artifacts
      uses: actions/download-artifact@v4
      with:
        name: build-files
        
    - name: ğŸ” Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
        
    - name: ğŸš€ Deploy Frontend to S3/CloudFront
      run: |
        echo "ğŸš€ Deploying AGROTM frontend to S3/CloudFront..."
        echo "ğŸ“ AWS Region: $AWS_REGION"
        echo "ğŸ”§ Frontend deployment in progress..."
        
        # Deploy para S3 e invalidar CloudFront
        # Adicione aqui os comandos especÃ­ficos do seu deploy
        echo "âœ… Frontend deployment completed"
        
    - name: ğŸ” Health Check Frontend
      run: |
        echo "ğŸ” Checking frontend health..."
        # Verificar se o frontend estÃ¡ funcionando
        # Adicione aqui os comandos de health check
        echo "âœ… Frontend health check completed"

  # ===== NOTIFICAÃ‡Ã•ES =====
  notify:
    needs: [deploy-backend, deploy-frontend]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: ğŸ“§ Send Success Notification
      if: success()
      run: |
        echo "âœ… AGROTM Deploy completed successfully!"
        echo "ğŸ‰ Backend and Frontend are now live"
        echo "ğŸ”— Check your deployment at your domain"
        # Adicione aqui notificaÃ§Ãµes por email/Slack
        
    - name: ğŸ“§ Send Failure Notification
      if: failure()
      run: |
        echo "âŒ AGROTM Deploy failed!"
        echo "ğŸš¨ Please check the logs for more details"
        # Adicione aqui notificaÃ§Ãµes por email/Slack

  # ===== SECURITY SCAN =====
  security:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ” Run Security Scan
      uses: snyk/actions/node@master
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
      with:
        args: --severity-threshold=high
        
    - name: ğŸ” Run Dependency Check
      run: |
        cd backend
        npm audit --audit-level=high
        cd ../frontend
        npm audit --audit-level=high
