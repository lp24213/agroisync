# =============================================================
# AGROISYNC ‚Ä¢ Deploy de Staging para Testes
# =============================================================

name: Deploy Staging

on:
  push:
    branches: [develop, staging]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Ambiente para deploy'
        required: true
        default: 'staging'
        type: choice
        options:
        - staging
        - preview

env:
  NODE_VERSION: '18'
  CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
  CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}

jobs:
  # Job para testes e valida√ß√µes
  test-and-validate:
    runs-on: ubuntu-latest
    name: Testes e Valida√ß√µes
    
    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Instalar depend√™ncias do frontend
        run: |
          cd frontend
          npm ci

      - name: Instalar depend√™ncias do backend
        run: |
          cd backend
          npm ci

      - name: Executar linting do frontend
        run: |
          cd frontend
          npm run lint

      - name: Executar linting do backend
        run: |
          cd backend
          npm run lint

      - name: Executar testes do frontend
        run: |
          cd frontend
          npm run test -- --coverage --watchAll=false

      - name: Executar testes do backend
        run: |
          cd backend
          npm run test

      - name: Build do frontend
        run: |
          cd frontend
          npm run build
        env:
          REACT_APP_API_URL: https://staging-api.agroisync.com
          REACT_APP_ENV: staging

      - name: Upload coverage do frontend
        uses: codecov/codecov-action@v3
        with:
          file: ./frontend/coverage/lcov.info
          flags: frontend
          name: frontend-coverage

      - name: Upload coverage do backend
        uses: codecov/codecov-action@v3
        with:
          file: ./backend/coverage/lcov.info
          flags: backend
          name: backend-coverage

  # Job para deploy do backend (Cloudflare Workers)
  deploy-backend:
    needs: test-and-validate
    runs-on: ubuntu-latest
    name: Deploy Backend (Staging)
    environment: staging-backend
    
    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Instalar Wrangler CLI
        run: npm install -g wrangler

      - name: Instalar depend√™ncias do backend
        run: |
          cd backend
          npm ci

      - name: Configurar secrets do Cloudflare Workers
        run: |
          cd backend
          echo "${{ secrets.STRIPE_SECRET_KEY }}" | wrangler secret put STRIPE_SECRET_KEY --env staging
          echo "${{ secrets.JWT_SECRET }}" | wrangler secret put JWT_SECRET --env staging
          echo "${{ secrets.RESEND_API_KEY }}" | wrangler secret put RESEND_API_KEY --env staging
          echo "${{ secrets.CLOUDFLARE_TURNSTILE_SECRET }}" | wrangler secret put CLOUDFLARE_TURNSTILE_SECRET --env staging
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Deploy do Cloudflare Worker
        run: |
          cd backend
          wrangler deploy --env staging
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Executar migra√ß√£o do banco D1
        run: |
          cd backend
          wrangler d1 execute agroisync-staging-db --file=./schema.sql --env staging
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Health check do backend
        run: |
          sleep 30
          curl -f https://staging-api.agroisync.com/api/health || exit 1

  # Job para deploy do frontend (Cloudflare Pages)
  deploy-frontend:
    needs: [test-and-validate, deploy-backend]
    runs-on: ubuntu-latest
    name: Deploy Frontend (Staging)
    environment: staging-frontend
    
    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Instalar Wrangler CLI
        run: npm install -g wrangler

      - name: Instalar depend√™ncias do frontend
        run: |
          cd frontend
          npm ci

      - name: Build do frontend para staging
        run: |
          cd frontend
          npm run build
        env:
          REACT_APP_API_URL: https://staging-api.agroisync.com
          REACT_APP_ENV: staging
          REACT_APP_STRIPE_PUBLISHABLE_KEY: ${{ secrets.STRIPE_PUBLISHABLE_KEY_STAGING }}
          REACT_APP_CLOUDFLARE_TURNSTILE_SITE_KEY: ${{ secrets.CLOUDFLARE_TURNSTILE_SITE_KEY }}

      - name: Deploy do Cloudflare Pages
        run: |
          cd frontend
          wrangler pages deploy build --project-name agroisync-staging --env staging
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Health check do frontend
        run: |
          sleep 30
          curl -f https://staging.agroisync.com || exit 1

  # Job para testes de integra√ß√£o
  integration-tests:
    needs: [deploy-backend, deploy-frontend]
    runs-on: ubuntu-latest
    name: Testes de Integra√ß√£o
    
    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Instalar depend√™ncias
        run: |
          cd frontend
          npm ci
          cd ../backend
          npm ci

      - name: Executar testes de integra√ß√£o
        run: |
          cd backend
          npm run test:integration
        env:
          API_URL: https://staging-api.agroisync.com
          FRONTEND_URL: https://staging.agroisync.com

      - name: Executar testes E2E
        run: |
          cd frontend
          npm run test:e2e
        env:
          BASE_URL: https://staging.agroisync.com
          API_URL: https://staging-api.agroisync.com

  # Job para notifica√ß√µes
  notify:
    needs: [integration-tests]
    runs-on: ubuntu-latest
    name: Notifica√ß√µes
    if: always()
    
    steps:
      - name: Notificar sucesso
        if: needs.integration-tests.result == 'success'
        run: |
          echo "‚úÖ Deploy de staging conclu√≠do com sucesso!"
          echo "üåê Frontend: https://staging.agroisync.com"
          echo "üîß Backend: https://staging-api.agroisync.com"
          echo "üìö API Docs: https://staging-api.agroisync.com/api-docs"

      - name: Notificar falha
        if: needs.integration-tests.result == 'failure'
        run: |
          echo "‚ùå Deploy de staging falhou!"
          echo "Verifique os logs para mais detalhes."

      - name: Enviar notifica√ß√£o para Slack
        if: always()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          channel: '#deployments'
          text: |
            Deploy de Staging: ${{ job.status }}
            Frontend: https://staging.agroisync.com
            Backend: https://staging-api.agroisync.com
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  # Job para limpeza (opcional)
  cleanup:
    needs: [notify]
    runs-on: ubuntu-latest
    name: Limpeza
    if: always()
    
    steps:
      - name: Limpar artefatos tempor√°rios
        run: |
          echo "Limpando artefatos tempor√°rios..."
          # Adicionar comandos de limpeza se necess√°rio

      - name: Limpar cache do npm
        run: |
          npm cache clean --force