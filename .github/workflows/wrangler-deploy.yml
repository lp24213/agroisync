name: Deploy AgroSync to Cloudflare

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy-backend:
    name: Deploy Backend (Workers)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"
          cache-dependency-path: backend/package-lock.json

      - name: Install dependencies
        run: |
          cd backend
          npm ci

      - name: Deploy to Cloudflare Workers
        run: |
          cd backend
          npx wrangler deploy src/cloudflare-worker.js --config wrangler.toml
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

  deploy-frontend:
    name: Deploy Frontend (Pages)
    runs-on: ubuntu-latest
    needs: deploy-backend
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: |
          cd frontend
          npm ci

      - name: Build frontend
        run: |
          cd frontend
          npm run build
        env:
          REACT_APP_API_URL: https://agroisync.com/api
          REACT_APP_TURNSTILE_SITE_KEY: 0x4AAAAAAAQ8VKGsaXcsV7Rd
          GENERATE_SOURCEMAP: false
          NODE_ENV: production

      - name: Deploy to Cloudflare Pages
        run: |
          cd frontend
          npx wrangler pages deploy build --project-name=agroisync --branch=main
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

  verify-deployment:
    name: Verify Deployment
    runs-on: ubuntu-latest
    needs: [deploy-backend, deploy-frontend]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Test Backend Health
        run: |
          echo "Testing backend health..."
          response=$(curl -s -o /dev/null -w "%{http_code}" https://agroisync.com/api/health)
          if [ "$response" -eq 200 ]; then
            echo "âœ… Backend is healthy (HTTP $response)"
          else
            echo "âŒ Backend health check failed (HTTP $response)"
            exit 1
          fi

      - name: Test Frontend
        run: |
          echo "Testing frontend..."
          response=$(curl -s -o /dev/null -w "%{http_code}" https://agroisync.com)
          if [ "$response" -eq 200 ]; then
            echo "âœ… Frontend is accessible (HTTP $response)"
          else
            echo "âŒ Frontend is not accessible (HTTP $response)"
            exit 1
          fi

      - name: Deployment Summary
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ‰ Deployment completed successfully!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸŒ Frontend: https://agroisync.com"
          echo "ğŸ“¡ Backend API: https://agroisync.com/api"
          echo "ğŸ” Health Check: https://agroisync.com/api/health"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
