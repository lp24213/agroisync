version: 1
frontend:
  phases:
    preBuild:
      commands:
        # ForÃ§ar Node.js 20.18.0
        - echo "ğŸ”„ Configurando Node.js 20.18.0..."
        - curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash
        - export NVM_DIR="$HOME/.nvm"
        - [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
        - nvm install 20.18.0
        - nvm use 20.18.0
        - nvm alias default 20.18.0
        - echo "âœ… Node.js $(node --version) ativado"
        - echo "âœ… NPM $(npm --version) ativado"
        
        # Detectar package manager e limpar cache
        - echo "ğŸ” Detectando package manager..."
        - if [ -f "yarn.lock" ]; then
            echo "ğŸ“¦ Yarn detectado - usando Yarn"
            - yarn --version
            - yarn cache clean
            - yarn install --frozen-lockfile --network-timeout 300000
          elif [ -f "package-lock.json" ]; then
            echo "ğŸ“¦ NPM detectado - verificando sincronizaÃ§Ã£o..."
            - npm ci --prefer-offline --no-audit || npm install --prefer-offline --no-audit
          else
            echo "ğŸ“¦ Nenhum lock file - usando npm install"
            - npm install --prefer-offline --no-audit
          fi
        
        # Verificar dependÃªncias crÃ­ticas
        - echo "ğŸ” Verificando dependÃªncias crÃ­ticas..."
        - npm list @types/react @types/react-dom @firebase/app @solana/web3.js || echo "âš ï¸ Algumas dependÃªncias podem estar faltando"
        
        # Configurar variÃ¡veis de ambiente
        - echo "âš™ï¸ Configurando variÃ¡veis de ambiente..."
        - export NODE_ENV=production
        - export NEXT_TELEMETRY_DISABLED=1
        
    build:
      commands:
        # Build otimizado para Next.js SSR
        - echo "ğŸ—ï¸ Iniciando build Next.js SSR..."
        - npm run build
        
        # Verificar build
        - echo "âœ… Build concluÃ­do - verificando arquivos..."
        - ls -la .next/
        - echo "ğŸ“Š Tamanho do build: $(du -sh .next/)"
        
        # Otimizar para produÃ§Ã£o
        - echo "ğŸš€ Otimizando para produÃ§Ã£o..."
        - npm run start:standalone || echo "âš ï¸ start:standalone nÃ£o disponÃ­vel"
        
  artifacts:
    baseDirectory: .next
    files:
      - '**/*'
    # ConfiguraÃ§Ã£o para Next.js standalone
    discard-paths: no
    
  cache:
    paths:
      # Cache de dependÃªncias
      - node_modules/**/*
      # Cache do Next.js
      - .next/cache/**/*
      # Cache do NPM/Yarn
      - ~/.npm/**/*
      - ~/.yarn/**/*
      # Cache do build
      - .next/standalone/**/*
      
  # ConfiguraÃ§Ãµes especÃ­ficas do Amplify
  customHeaders:
    - pattern: '**/*'
      headers:
        - key: 'X-Frame-Options'
          value: 'DENY'
        - key: 'X-XSS-Protection'
          value: '1; mode=block'
        - key: 'X-Content-Type-Options'
          value: 'nosniff'
        - key: 'Referrer-Policy'
          value: 'strict-origin-when-cross-origin'
        - key: 'Permissions-Policy'
          value: 'camera=(), microphone=(), geolocation=()'
          
  # ConfiguraÃ§Ãµes de build
  buildPath: .next
  distributionDir: .next
  
  # VariÃ¡veis de ambiente do build
  environmentVariables:
    NODE_ENV: production
    NEXT_TELEMETRY_DISABLED: 1
    NODE_OPTIONS: "--max-old-space-size=4096"
