version: 1
frontend:
  phases:
    preBuild:
      commands:
        - echo "=== INSTALANDO NODE.JS CORRETO ==="
        - nvm install 20.18.0
        - nvm use 20.18.0
        - node --version
        - npm --version
        - echo "=== ENTRANDO NO DIRETÓRIO FRONTEND ==="
        - cd frontend
        - echo "=== LIMPANDO INSTALAÇÕES ANTERIORES ==="
        - rm -rf node_modules package-lock.json .next
        - echo "=== INSTALANDO DEPENDÊNCIAS COM OTIMIZAÇÕES ==="
        - npm install --no-optional --no-audit --no-fund --prefer-offline --production=false
        - echo "=== LIMPANDO CACHE DO NPM ==="
        - npm cache clean --force
        - echo "=== VERIFICANDO MEMÓRIA DISPONÍVEL ==="
        - free -h || echo "Comando free não disponível"
        - df -h
    build:
      commands:
        - echo "=== INICIANDO BUILD OTIMIZADO PARA AMPLIFY ==="
        - export NODE_OPTIONS="--max-old-space-size=4096"
        - export NEXT_TELEMETRY_DISABLED=1
        - npm run build:amplify
        - echo "=== BUILD COMPLETADO ==="
        - ls -la .next
        - echo "=== VERIFICANDO ARQUIVOS ==="
        - find .next -name "*.js" | head -10
        - echo "=== VERIFICANDO TAMANHO ==="
        - du -sh .next || echo "Comando du não disponível"
  artifacts:
    baseDirectory: frontend/.next
    files:
      - '**/*'
  cache:
    paths:
      - frontend/node_modules/**/*
      - frontend/.next/cache/**/*
