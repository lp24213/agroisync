version: 1
frontend:
  phases:
    preBuild:
      commands:
        - echo "ğŸ”§ Configurando ambiente..."
        - node --version
        - npm --version
        - echo "ğŸ“¦ Instalando dependÃªncias..."
        - npm install --legacy-peer-deps
        - echo "âœ… DependÃªncias instaladas"
        - echo "ğŸ” Detectando framework..."
        - if (Test-Path "package.json") { $pkg = Get-Content "package.json" | ConvertFrom-Json; Write-Host "Framework detectado: $($pkg.dependencies.keys | Where-Object { $_ -like "*next*" -or $_ -like "*react*" -or $_ -like "*vite*" })" }
    build:
      commands:
        - echo "ğŸ—ï¸ Building aplicaÃ§Ã£o..."
        - npm run build
        - echo "âœ… Build concluÃ­do"
        - echo "ğŸ” Verificando framework e pasta de saÃ­da..."
        - if (Test-Path "out") { Write-Host "âœ… Next.js detectado - pasta out criada"; $OUTPUT_DIR = "out" } elseif (Test-Path "build") { Write-Host "âœ… React CRA detectado - pasta build criada"; $OUTPUT_DIR = "build" } elseif (Test-Path "dist") { Write-Host "âœ… Vite detectado - pasta dist criada"; $OUTPUT_DIR = "dist" } else { Write-Host "âŒ Nenhuma pasta de saÃ­da encontrada"; exit 1 }
        - echo "ğŸ“‹ Verificando diretÃ³rio de saÃ­da: $OUTPUT_DIR"
        - ls -la $OUTPUT_DIR/
        - echo "ğŸ“ ConteÃºdo do diretÃ³rio $OUTPUT_DIR:"
        - find $OUTPUT_DIR/ -type f | head -20
        - echo "ğŸ” Verificando arquivo index.html..."
        - if (Test-Path "$OUTPUT_DIR/index.html") { cat $OUTPUT_DIR/index.html | head -10 } else { echo "âŒ index.html nÃ£o encontrado"; exit 1 }
        - echo "ğŸ“Š Tamanho dos arquivos principais:"
        - ls -lh $OUTPUT_DIR/index.html
        - if (Test-Path "$OUTPUT_DIR/_next") { ls -lh $OUTPUT_DIR/_next/static/chunks/pages/index-*.js } else { echo "â„¹ï¸ Pasta _next nÃ£o encontrada (nÃ£o Ã© Next.js)" }
        - echo "ğŸ”§ Criando arquivo de configuraÃ§Ã£o para SPA..."
        - echo '{"rewrites":[{"source":"/**","destination":"/index.html"}]}' > $OUTPUT_DIR/amplify.json
        - echo "âœ… ConfiguraÃ§Ã£o SPA criada"
        - echo "ğŸ”§ Criando arquivo de redirecionamento..."
        - echo "/*    /index.html   200" > $OUTPUT_DIR/_redirects
        - echo "âœ… Redirecionamentos configurados"
        - echo "ğŸ“ Salvando diretÃ³rio de saÃ­da para uso posterior..."
        - echo $OUTPUT_DIR > .output_dir
    postBuild:
      commands:
        - echo "ğŸ‰ Deploy pronto!"
        - echo "ğŸš€ Frontend + Backend integrados funcionando!"
        - $OUTPUT_DIR = Get-Content .output_dir
        - echo "ğŸ“ Estrutura final do diretÃ³rio $OUTPUT_DIR:"
        - tree $OUTPUT_DIR/ || find $OUTPUT_DIR/ -type f | sort
        - echo "ğŸ”§ Verificando configuraÃ§Ã£o SPA..."
        - cat $OUTPUT_DIR/amplify.json
        - echo "ğŸ”§ Verificando redirecionamentos..."
        - cat $OUTPUT_DIR/_redirects
        - echo "ğŸ¯ DiretÃ³rio final configurado: $OUTPUT_DIR"
  artifacts:
    baseDirectory: out
    files:
      - '**/*'
  cache:
    paths:
      - node_modules/**/*
      - .next/cache/**/*
      - out/**/*
      - build/**/*
      - dist/**/*
