version: 1
frontend:
  phases:
    preBuild:
      commands:
        - echo "üöÄ AGROISYNC Build AWS Amplify (Node 20)"
        - nvm install 20
        - nvm use 20
        - node --version
        - npm --version
        - cd frontend
        - echo "Cleaning previous build artifacts..."
        - rm -rf .next out node_modules package-lock.json
        - echo "Installing ALL dependencies including dev dependencies..."
        - npm ci --production=false --include=dev
        - echo "Verifying TypeScript installation..."
        - npx tsc --version || echo "TypeScript not found, installing..."
        - npm install typescript@latest --save-dev || echo "TypeScript installation failed, continuing..."
        - echo "Dependencies installed successfully"
    build:
      commands:
        - echo "Starting build process..."
        - npm run build
        - echo "Build completed successfully"
        - ls -la .next/standalone/frontend
    postBuild:
      commands:
        - echo "Checking essential files..."
        - ls -la .next/standalone/frontend
        - echo "Verifying build output..."
        - test -f .next/standalone/frontend/server.js && echo "‚úÖ server.js found" || echo "‚ùå server.js missing"
        - test -d .next/standalone/frontend/app && echo "‚úÖ app directory found" || echo "‚ùå app directory missing"
        - test -d .next/standalone/frontend/public && echo "‚úÖ public directory found" || echo "‚ùå public directory missing"
        - echo "Deploy ready"
  artifacts:
    baseDirectory: frontend/.next/standalone/frontend
    files:
      - '**/*'
  cache:
    paths:
      - frontend/node_modules/**/*
      - frontend/.next/cache/**/*
