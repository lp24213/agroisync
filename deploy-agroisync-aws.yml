# AgroSync AWS Deployment Configuration
# Configuração completa para deploy na AWS

version: '1.0'
project:
  name: "AgroSync"
  version: "1.0.0"
  description: "Plataforma de agricultura inteligente e tokenização de ativos rurais"

# Frontend Configuration (AWS Amplify)
frontend:
  platform: "aws-amplify"
  framework: "nextjs"
  build_settings:
    build_command: "npm run build"
    output_directory: ".next"
    install_command: "npm ci"
    environment_variables:
      NODE_ENV: "production"
      NEXT_PUBLIC_API_URL: "https://api.agroisync.com"
      NEXT_PUBLIC_APP_NAME: "AgroSync"
      NEXT_PUBLIC_APP_VERSION: "1.0.0"
  
  domain:
    main: "agroisync.com"
    www: "www.agroisync.com"
    api: "api.agroisync.com"
    storage: "storage.agroisync.com"
  
  ssl_certificate:
    provider: "aws-acm"
    region: "us-east-1"
    validation_method: "dns"

# Backend Configuration (AWS ECS)
backend:
  platform: "aws-ecs"
  service_name: "agroisync-backend"
  cluster_name: "agroisync-cluster"
  
  container:
    image: "agroisync-backend"
    port: 3001
    cpu: "1024"
    memory: "2048"
    health_check_path: "/health"
  
  load_balancer:
    type: "application"
    port: 80
    ssl_port: 443
    health_check_path: "/health"
  
  auto_scaling:
    min_capacity: 2
    max_capacity: 10
    target_cpu_utilization: 70
    target_memory_utilization: 80

# Database Configuration (AWS RDS)
database:
  engine: "postgresql"
  version: "15.4"
  instance_class: "db.t3.micro"
  allocated_storage: 20
  storage_type: "gp2"
  multi_az: false
  
  credentials:
    username: "agroisync_admin"
    password_secret: "agroisync/db-password"
  
  backup:
    retention_period: 7
    backup_window: "03:00-04:00"
    maintenance_window: "sun:04:00-sun:05:00"

# Cache Configuration (AWS ElastiCache)
cache:
  engine: "redis"
  version: "7.0"
  node_type: "cache.t3.micro"
  num_cache_nodes: 1
  port: 6379
  
  security:
    encryption_at_rest: true
    encryption_in_transit: true

# Storage Configuration (AWS S3)
storage:
  bucket_name: "agroisync-storage"
  region: "us-east-1"
  
  lifecycle_rules:
    - id: "uploads-cleanup"
      status: "Enabled"
      transitions:
        - days: 30
          storage_class: "STANDARD_IA"
        - days: 90
          storage_class: "GLACIER"
      expiration:
        days: 365
  
  cors_configuration:
    allowed_origins: ["https://agroisync.com", "https://www.agroisync.com"]
    allowed_methods: ["GET", "POST", "PUT", "DELETE"]
    allowed_headers: ["*"]
    max_age_seconds: 3000

# Security Configuration
security:
  vpc:
    cidr_block: "10.0.0.0/16"
    subnets:
      - cidr: "10.0.1.0/24"
        availability_zone: "us-east-1a"
        type: "public"
      - cidr: "10.0.2.0/24"
        availability_zone: "us-east-1b"
        type: "public"
      - cidr: "10.0.3.0/24"
        availability_zone: "us-east-1a"
        type: "private"
      - cidr: "10.0.4.0/24"
        availability_zone: "us-east-1b"
        type: "private"
  
  security_groups:
    - name: "agroisync-backend-sg"
      description: "Security group for AgroSync backend"
      rules:
        - type: "ingress"
          port: 3001
          source: "agroisync-alb-sg"
        - type: "egress"
          port: 0
          source: "0.0.0.0/0"
    
    - name: "agroisync-alb-sg"
      description: "Security group for Application Load Balancer"
      rules:
        - type: "ingress"
          port: 80
          source: "0.0.0.0/0"
        - type: "ingress"
          port: 443
          source: "0.0.0.0/0"
        - type: "egress"
          port: 0
          source: "0.0.0.0/0"

# Monitoring Configuration
monitoring:
  cloudwatch:
    log_groups:
      - name: "/ecs/agroisync-backend"
        retention_days: 30
      - name: "/aws/amplify/agroisync"
        retention_days: 30
  
  alarms:
    - name: "HighCPUUtilization"
      metric: "CPUUtilization"
      threshold: 80
      period: 300
      evaluation_periods: 2
    
    - name: "HighMemoryUtilization"
      metric: "MemoryUtilization"
      threshold: 80
      period: 300
      evaluation_periods: 2
    
    - name: "HighErrorRate"
      metric: "HTTPCode_Target_5XX_Count"
      threshold: 10
      period: 300
      evaluation_periods: 2

# CI/CD Configuration
cicd:
  provider: "github-actions"
  workflows:
    - name: "deploy-frontend"
      file: ".github/workflows/deploy-frontend.yml"
      triggers: ["push", "pull_request"]
      branches: ["main", "develop"]
    
    - name: "deploy-backend"
      file: ".github/workflows/deploy-backend.yml"
      triggers: ["push", "pull_request"]
      branches: ["main", "develop"]
  
  secrets:
    - name: "AWS_ACCESS_KEY_ID"
      source: "github"
    - name: "AWS_SECRET_ACCESS_KEY"
      source: "github"
    - name: "AWS_REGION"
      source: "github"
    - name: "AMPLIFY_APP_ID"
      source: "github"

# Environment Variables
environment:
  production:
    NODE_ENV: "production"
    PORT: "3001"
    DB_HOST: "agroisync-db.${AWS_REGION}.rds.amazonaws.com"
    DB_PORT: "5432"
    DB_NAME: "agroisync_production"
    REDIS_HOST: "agroisync-cache.${AWS_REGION}.cache.amazonaws.com"
    REDIS_PORT: "6379"
    JWT_SECRET: "arn:aws:secretsmanager:${AWS_REGION}:${AWS_ACCOUNT_ID}:secret:agroisync/jwt-secret"
    CORS_ORIGIN: "https://agroisync.com,https://www.agroisync.com"
  
  staging:
    NODE_ENV: "staging"
    PORT: "3001"
    DB_HOST: "agroisync-staging-db.${AWS_REGION}.rds.amazonaws.com"
    DB_PORT: "5432"
    DB_NAME: "agroisync_staging"
    REDIS_HOST: "agroisync-staging-cache.${AWS_REGION}.cache.amazonaws.com"
    REDIS_PORT: "6379"
    JWT_SECRET: "arn:aws:secretsmanager:${AWS_REGION}:${AWS_ACCOUNT_ID}:secret:agroisync-staging/jwt-secret"
    CORS_ORIGIN: "https://staging.agroisync.com"

# Deployment Steps
deployment_steps:
  1: "Create VPC and networking infrastructure"
  2: "Deploy RDS PostgreSQL database"
  3: "Deploy ElastiCache Redis cluster"
  4: "Create ECR repository for backend images"
  5: "Deploy ECS cluster and backend service"
  6: "Configure Application Load Balancer"
  7: "Deploy frontend to AWS Amplify"
  8: "Configure custom domain and SSL certificates"
  9: "Set up monitoring and alerting"
  10: "Configure CI/CD pipelines"
  11: "Run health checks and validation tests"
  12: "Update DNS records"

# Cost Estimation (Monthly)
cost_estimation:
  frontend: "$0.50"  # Amplify hosting
  backend: "$15.00"  # ECS Fargate
  database: "$12.00" # RDS PostgreSQL
  cache: "$8.00"     # ElastiCache Redis
  storage: "$0.50"   # S3 storage
  networking: "$5.00" # ALB + Data transfer
  monitoring: "$2.00" # CloudWatch
  total: "$43.00"

# Maintenance
maintenance:
  database_backup: "Daily at 3 AM UTC"
  security_updates: "Weekly on Sundays"
  monitoring_review: "Daily"
  cost_optimization: "Monthly"
  performance_review: "Weekly"
